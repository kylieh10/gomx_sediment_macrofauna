<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kylie Hollis">
<meta name="author" content="Stephen Formel">
<meta name="dcterms.date" content="2024-08-15">

<title>DRAFT, UNDER DEVELOPMENT: Demopoulos Lab OBIS Mobilization Workflow</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="demopoulos_obis_mobilization_workflow_files/libs/clipboard/clipboard.min.js"></script>
<script src="demopoulos_obis_mobilization_workflow_files/libs/quarto-html/quarto.js"></script>
<script src="demopoulos_obis_mobilization_workflow_files/libs/quarto-html/popper.min.js"></script>
<script src="demopoulos_obis_mobilization_workflow_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="demopoulos_obis_mobilization_workflow_files/libs/quarto-html/anchor.min.js"></script>
<link href="demopoulos_obis_mobilization_workflow_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="demopoulos_obis_mobilization_workflow_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="demopoulos_obis_mobilization_workflow_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="demopoulos_obis_mobilization_workflow_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="demopoulos_obis_mobilization_workflow_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="demopoulos_obis_mobilization_workflow_files/libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">

<script src="demopoulos_obis_mobilization_workflow_files/libs/tabwid-1.1.3/tabwid.js"></script>



</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#purpose" id="toc-purpose" class="nav-link active" data-scroll-target="#purpose">Purpose</a>
  <ul class="collapse">
  <li><a href="#open-science-obis-and-gbif" id="toc-open-science-obis-and-gbif" class="nav-link" data-scroll-target="#open-science-obis-and-gbif">Open Science, OBIS, and GBIF</a>
  <ul class="collapse">
  <li><a href="#open-science-and-fair-data" id="toc-open-science-and-fair-data" class="nav-link" data-scroll-target="#open-science-and-fair-data">Open Science and FAIR Data</a></li>
  <li><a href="#obis-and-gbif" id="toc-obis-and-gbif" class="nav-link" data-scroll-target="#obis-and-gbif">OBIS and GBIF</a></li>
  </ul></li>
  <li><a href="#what-is-darwin-core" id="toc-what-is-darwin-core" class="nav-link" data-scroll-target="#what-is-darwin-core">What is Darwin Core?</a></li>
  <li><a href="#what-is-eml" id="toc-what-is-eml" class="nav-link" data-scroll-target="#what-is-eml">What is EML?</a></li>
  </ul></li>
  <li><a href="#intended-user" id="toc-intended-user" class="nav-link" data-scroll-target="#intended-user">Intended User</a></li>
  <li><a href="#dataset-background" id="toc-dataset-background" class="nav-link" data-scroll-target="#dataset-background">Dataset Background</a>
  <ul class="collapse">
  <li><a href="#what-data-are-we-using-in-this-notebook" id="toc-what-data-are-we-using-in-this-notebook" class="nav-link" data-scroll-target="#what-data-are-we-using-in-this-notebook">What data are we using in this notebook?</a></li>
  </ul></li>
  <li><a href="#getting-a-feel-for-the-data" id="toc-getting-a-feel-for-the-data" class="nav-link" data-scroll-target="#getting-a-feel-for-the-data">Getting a feel for the data</a>
  <ul class="collapse">
  <li><a href="#modeling-the-data" id="toc-modeling-the-data" class="nav-link" data-scroll-target="#modeling-the-data">Modeling the Data</a></li>
  <li><a href="#mapping-to-darwin-core" id="toc-mapping-to-darwin-core" class="nav-link" data-scroll-target="#mapping-to-darwin-core">Mapping to Darwin Core</a></li>
  </ul></li>
  <li><a href="#version-control-with-git" id="toc-version-control-with-git" class="nav-link" data-scroll-target="#version-control-with-git">Version Control with Git</a>
  <ul class="collapse">
  <li><a href="#gitlab-vs-github" id="toc-gitlab-vs-github" class="nav-link" data-scroll-target="#gitlab-vs-github">Gitlab vs Github</a></li>
  </ul></li>
  <li><a href="#wrangling-the-data" id="toc-wrangling-the-data" class="nav-link" data-scroll-target="#wrangling-the-data">Wrangling the Data</a>
  <ul class="collapse">
  <li><a href="#using-r-to-get-the-data-from-sciencebase" id="toc-using-r-to-get-the-data-from-sciencebase" class="nav-link" data-scroll-target="#using-r-to-get-the-data-from-sciencebase">Using R to get the data from ScienceBase</a></li>
  <li><a href="#using-r-to-transform-the-data" id="toc-using-r-to-transform-the-data" class="nav-link" data-scroll-target="#using-r-to-transform-the-data">Using R to transform the data</a>
  <ul class="collapse">
  <li><a href="#renaming-columns" id="toc-renaming-columns" class="nav-link" data-scroll-target="#renaming-columns">Renaming Columns</a></li>
  <li><a href="#mutating-columns" id="toc-mutating-columns" class="nav-link" data-scroll-target="#mutating-columns">Mutating Columns</a></li>
  <li><a href="#adding-new-metadata" id="toc-adding-new-metadata" class="nav-link" data-scroll-target="#adding-new-metadata">Adding new metadata</a></li>
  <li><a href="#reconfiguring-tables" id="toc-reconfiguring-tables" class="nav-link" data-scroll-target="#reconfiguring-tables">Reconfiguring Tables</a></li>
  <li><a href="#writing-data" id="toc-writing-data" class="nav-link" data-scroll-target="#writing-data">Writing Data</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#uploading-to-the-ipt" id="toc-uploading-to-the-ipt" class="nav-link" data-scroll-target="#uploading-to-the-ipt">Uploading to the IPT</a></li>
  <li><a href="#creating-eml-metadata" id="toc-creating-eml-metadata" class="nav-link" data-scroll-target="#creating-eml-metadata">Creating EML Metadata</a></li>
  <li><a href="#publishing-to-obis-and-gbif" id="toc-publishing-to-obis-and-gbif" class="nav-link" data-scroll-target="#publishing-to-obis-and-gbif">Publishing to OBIS and GBIF</a></li>
  <li><a href="#understanding-dataset-use-statistics" id="toc-understanding-dataset-use-statistics" class="nav-link" data-scroll-target="#understanding-dataset-use-statistics">Understanding Dataset Use Statistics</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DRAFT, UNDER DEVELOPMENT: Demopoulos Lab OBIS Mobilization Workflow</h1>
<p class="subtitle lead">An elegant guide to mobilizing data to OBIS for the discerning member of the Demopoulos lab.</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Kylie Hollis <a href="mailto:khollis@usgs.gov" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0009-0006-4061-8077" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
             <p>Stephen Formel <a href="mailto:sformel@usgs.gov" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0001-7418-1244" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 15, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="purpose" class="level1">
<h1>Purpose</h1>
<p>This notebook aims to provide a general workflow for mobilizing the Demopoulos Lab’s data to OBIS to use in the future for similar tasks. Using an existing dataset as an example, we will walk through some brief contextual information; understanding, wrangling, and reconfiguring the data; adding metadata; and the publishing process.</p>
<section id="open-science-obis-and-gbif" class="level2">
<h2 class="anchored" data-anchor-id="open-science-obis-and-gbif">Open Science, OBIS, and GBIF</h2>
<section id="open-science-and-fair-data" class="level3">
<h3 class="anchored" data-anchor-id="open-science-and-fair-data">Open Science and FAIR Data</h3>
<p>Open science is the practice of making data, resources, results, and publications as available as possible, while still respecting diverse cultures, security, and privacy.</p>
<p>FAIR data is data that is findable, accessible, interoperable, and reusable. While the two often go hand-in-hand, FAIRness doesn’t require openness. However, by practicing the principles of open and FAIR science, we promote transparency in the scientific process. This transparency encourages collaboration, more efficient scientific advancements, and policy changes, while also increasing the impact of research.</p>
</section>
<section id="obis-and-gbif" class="level3">
<h3 class="anchored" data-anchor-id="obis-and-gbif">OBIS and GBIF</h3>
<p>The Ocean Biodiversity Information System (OBIS) and Global Biodiversity Information Facility (GBIF) are international networks that mobilize data to provide free, open access to biodiversity data. They promote global scientific collaboration and open science as pillars of their missions, which is facilitated by the use of data standards and FAIR principles.</p>
</section>
</section>
<section id="what-is-darwin-core" class="level2">
<h2 class="anchored" data-anchor-id="what-is-darwin-core">What is Darwin Core?</h2>
<p>Darwin Core (DwC) is a set of data standards from Biodiversity Information Standards (TDWG). It includes standardized vocabulary and file format for Darwin Core Archives, which contains an <code>event</code> or <code>occurrence</code> core file, extension files, and metadata files.</p>
<p>DwC is used by both OBIS and GBIF to help facilitate the sharing of open biological data in accordance with the FAIR principles.</p>
</section>
<section id="what-is-eml" class="level2">
<h2 class="anchored" data-anchor-id="what-is-eml">What is EML?</h2>
<p>Ecological Metadata Language (EML)</p>
</section>
</section>
<section id="intended-user" class="level1">
<h1>Intended User</h1>
</section>
<section id="dataset-background" class="level1">
<h1>Dataset Background</h1>
<section id="what-data-are-we-using-in-this-notebook" class="level2">
<h2 class="anchored" data-anchor-id="what-data-are-we-using-in-this-notebook">What data are we using in this notebook?</h2>
<p>We will be using data published by USGS, titled “Sediment macrofaunal composition, sediment grain size, and taxa functional traits of multiple deep-sea coral habitats in the Gulf of Mexico, 2009-2014”, collected by Dr.&nbsp;Amanda Demopoulos and Dr.&nbsp;Jill Bourque. DOI: https://doi.org/10.5066/F7TH8KXD</p>
<p>This data describes a series of sampling events where cores are taken near one of several types coral and analyzed for sediment composition or subsampled for macrofauna.</p>
</section>
</section>
<section id="getting-a-feel-for-the-data" class="level1">
<h1>Getting a feel for the data</h1>
<p>Starting to understand the data we are working with may not require a computer. Simple diagrams and maps can be very useful in this stage to understand the relationships and information provided in a dataset. To get started, it’s valuable to model the data and begin the process of mapping terms to DwC vocabulary.</p>
<section id="modeling-the-data" class="level2">
<h2 class="anchored" data-anchor-id="modeling-the-data">Modeling the Data</h2>
<p>Modeling the data and the relationships may be essential in understanding more complex datasets or those with multiple, related tables. This can be done with simple hand drawn diagrams or computer-generated diagrams, like mermaid diagrams.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="data_visualization.png" class="img-fluid figure-img"></p>
<figcaption>Hand-drawn data visualization of relationships</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Mermaid_diagram.png" class="img-fluid figure-img"></p>
<figcaption>Mermaid diagram visualization of the same data</figcaption>
</figure>
</div>
</section>
<section id="mapping-to-darwin-core" class="level2">
<h2 class="anchored" data-anchor-id="mapping-to-darwin-core">Mapping to Darwin Core</h2>
<p>Once we have a better grasp on the relationships in our data and what cores or extensions we might use, deciding what DwC terms to use becomes easier. Going through each column, we will need to determine what DwC terms are most appropriate and if term relationships are 1:1, 1:many, many:1, or 1:0, which will be valuable in wrangling the data.</p>
<p>While a computer is not required here, it may be useful to have access to DwC vocabulary pages to reference in this process.</p>
</section>
</section>
<section id="version-control-with-git" class="level1">
<h1>Version Control with Git</h1>
<section id="gitlab-vs-github" class="level2">
<h2 class="anchored" data-anchor-id="gitlab-vs-github">Gitlab vs Github</h2>
</section>
</section>
<section id="wrangling-the-data" class="level1">
<h1>Wrangling the Data</h1>
<section id="using-r-to-get-the-data-from-sciencebase" class="level2">
<h2 class="anchored" data-anchor-id="using-r-to-get-the-data-from-sciencebase">Using R to get the data from ScienceBase</h2>
<p>To retrieve and use the data from ScienceBase, R packages <code>dplyr</code>, <code>sbtools</code>, <code>stringr</code>, and <code>worrms</code> will need to be loaded. After loading these packages, we will read the data in from ScienceBase.</p>
<p>The ScienceBase dataset ID can be found at the end of the ScienceBase link for the dataset. If the full link to the data is “https://www.sciencebase.gov/catalog/item/5a709594e4b0a9a2e9d88e4e”, then the identifier is <code>5a709594e4b0a9a2e9d88e4e</code>.</p>
<p>Using the ScienceBase ID, we will get information about the data files using <code>item_list_files(sb_id = sb_id)</code> and assign it to an object <code>sb_filenames</code>.</p>
<p>From the object <code>sb_filenames</code>, we will pull the column <code>url</code>. This column contains the url needed to download the data file from ScienceBase. Rather than download a local copy of the files, we will read it directly into the memory of our computer with <code>readr:: read_csv(file = sb_filenames$url[n])</code>, with n being the row number of the file we are reading. Now we have dataframes to work with!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sbtools)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(worrms)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>sb_id <span class="ot">&lt;-</span> <span class="st">'5a709594e4b0a9a2e9d88e4e'</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>sb_filenames <span class="ot">&lt;-</span> <span class="fu">item_list_files</span>(<span class="at">sb_id =</span> sb_id)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>BTA <span class="ot">&lt;-</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="at">file =</span> sb_filenames<span class="sc">$</span>url[<span class="dv">1</span>])</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>Infauna <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="at">file =</span> sb_filenames<span class="sc">$</span>url[<span class="dv">2</span>])</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>SedChem <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="at">file =</span> sb_filenames<span class="sc">$</span>url[<span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="using-r-to-transform-the-data" class="level2">
<h2 class="anchored" data-anchor-id="using-r-to-transform-the-data">Using R to transform the data</h2>
<p>After loading the data, we will have to transform the data to align with DarwinCore standard formats and terms.</p>
<section id="renaming-columns" class="level3">
<h3 class="anchored" data-anchor-id="renaming-columns">Renaming Columns</h3>
<p>Some column names may directly correlate with the definitions of some DwC terms (a 1:1 relationship), meaning we only have to rename them. To preserve the original data, we will create a new table from <code>Infauna</code> to do the manipulations. Then, we will use <code>rename(newName = oldName)</code> to assign new column names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Infauna_StationCore <span class="ot">&lt;-</span> Infauna <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationRemarks =</span> Location,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">materialEntityID =</span> CoreID,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationID =</span> Station,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLatitude =</span> Latitude,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLongitude =</span> Longitude</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mutating-columns" class="level3">
<h3 class="anchored" data-anchor-id="mutating-columns">Mutating Columns</h3>
<p>Some renaming might be slightly more complex, requiring manipulation of a column’s format or content to fit the DwC standard. For these tasks, we will use the <code>mutate</code> function.</p>
<p>In this case, the column may be in the wrong format, like <code>DateCollected</code> which needs to be adjusted before being assigned to <code>eventDate</code>. Others, like <code>eventDate</code> or <code>samplingProtocol</code>, are concatenations of other columns (many:1 relationships), which can be combined with <code>paste</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>Infauna_StationCore <span class="ot">&lt;-</span> Infauna_StationCore <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">geodeticDatum =</span> <span class="st">"WGS84"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate =</span> DateCollected <span class="sc">%&gt;%</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(<span class="st">"%m/%d/%Y"</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> <span class="fu">paste</span>(Site, eventDate <span class="sc">%&gt;%</span> <span class="fu">as.character</span>(), locationID, materialEntityID,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">sep =</span> <span class="st">"_"</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="at">pattern =</span> <span class="st">"-"</span>),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">minimumDepthInMeters =</span> Depth,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">maximumDepthInMeters =</span> Depth,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">locality =</span> <span class="fu">paste</span>(<span class="st">"BOEM Lease Block"</span>, Site),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">higherGeography =</span> <span class="fu">paste</span>(<span class="st">"Gulf of Mexico"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">paste</span>(<span class="st">"BOEM Lease Block"</span>, </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                                  Site), <span class="at">sep =</span> <span class="st">" | "</span>),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="fu">paste</span>(Gear, CoreDiameter, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adding-new-metadata" class="level3">
<h3 class="anchored" data-anchor-id="adding-new-metadata">Adding new metadata</h3>
</section>
<section id="reconfiguring-tables" class="level3">
<h3 class="anchored" data-anchor-id="reconfiguring-tables">Reconfiguring Tables</h3>
<p>For some extensions, like the <code>extendedMeasurementOrFact</code> extension, imported data may have different configurations than required by DwC, requiring reconfiguration.</p>
<section id="pivoting" class="level4">
<h4 class="anchored" data-anchor-id="pivoting">Pivoting</h4>
<p>After renaming and mutating column names, we may have to pivot the table from wide to long format. For <code>extendedMeasurementOrFact</code> tables, all columns in wide format need to be pivoted into long format.</p>
<p>Example of Wide Format</p>
<p>::: {#tbl-tidyformat wide .cell} ::: {.cell-output .cell-output-stderr}</p>
<pre><code>Warning: package 'flextable' was built under R version 4.4.1</code></pre>
<p>:::</p>
<div class="cell-output-display">
<div class="tabwid"><style>.cl-c91c4fde{}.cl-c9105fc6{font-family:'Arial';font-size:11pt;font-weight:bold;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c9105fe4{font-family:'Arial';font-size:9pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c913c47c{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c913c486{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c913f6ea{width:1.133in;background-color:rgba(207, 207, 207, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c913f6f4{width:0.778in;background-color:rgba(207, 207, 207, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c913f6f5{width:1.133in;background-color:rgba(239, 239, 239, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c913f6f6{width:0.778in;background-color:rgba(239, 239, 239, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c913f6fe{width:1.133in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c913f708{width:0.778in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing="true" class="cl-c91c4fde"><thead><tr style="overflow-wrap:break-word;"><th class="cl-c913f6ea"><p class="cl-c913c47c"><span class="cl-c9105fc6">species</span></p></th><th class="cl-c913f6f4"><p class="cl-c913c486"><span class="cl-c9105fc6">site_01</span></p></th><th class="cl-c913f6f4"><p class="cl-c913c486"><span class="cl-c9105fc6">site_02</span></p></th><th class="cl-c913f6f4"><p class="cl-c913c486"><span class="cl-c9105fc6">site_03</span></p></th></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-c913f6f5"><p class="cl-c913c47c"><span class="cl-c9105fe4">Tilia americana</span></p></td><td class="cl-c913f6f6"><p class="cl-c913c486"><span class="cl-c9105fe4">2</span></p></td><td class="cl-c913f6f6"><p class="cl-c913c486"><span class="cl-c9105fe4">1</span></p></td><td class="cl-c913f6f6"><p class="cl-c913c486"><span class="cl-c9105fe4">2</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-c913f6fe"><p class="cl-c913c47c"><span class="cl-c9105fe4">Pinus strobus</span></p></td><td class="cl-c913f708"><p class="cl-c913c486"><span class="cl-c9105fe4">3</span></p></td><td class="cl-c913f708"><p class="cl-c913c486"><span class="cl-c9105fe4">0</span></p></td><td class="cl-c913f708"><p class="cl-c913c486"><span class="cl-c9105fe4">4</span></p></td></tr></tbody></table></div>
</div>
<p>:::</p>
<p>Example of Long Format</p>
<p>::: {#tbl-tidyformat long .cell} ::: {.cell-output-display}</p>
<div class="tabwid"><style>.cl-c94ae4d4{}.cl-c9419d8e{font-family:'Arial';font-size:11pt;font-weight:bold;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c9419d98{font-family:'Arial';font-size:9pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c944d08a{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c944d094{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c944e76e{width:1.133in;background-color:rgba(207, 207, 207, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c944e778{width:0.688in;background-color:rgba(207, 207, 207, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c944e779{width:0.659in;background-color:rgba(207, 207, 207, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c944e77a{width:1.133in;background-color:rgba(239, 239, 239, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c944e77b{width:0.688in;background-color:rgba(239, 239, 239, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c944e782{width:0.659in;background-color:rgba(239, 239, 239, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c944e783{width:1.133in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c944e784{width:0.688in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c944e78c{width:0.659in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing="true" class="cl-c94ae4d4"><thead><tr style="overflow-wrap:break-word;"><th class="cl-c944e76e"><p class="cl-c944d08a"><span class="cl-c9419d8e">species</span></p></th><th class="cl-c944e778"><p class="cl-c944d08a"><span class="cl-c9419d8e">site</span></p></th><th class="cl-c944e779"><p class="cl-c944d094"><span class="cl-c9419d8e">count</span></p></th></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-c944e77a"><p class="cl-c944d08a"><span class="cl-c9419d98">Tilia americana</span></p></td><td class="cl-c944e77b"><p class="cl-c944d08a"><span class="cl-c9419d98">site_01</span></p></td><td class="cl-c944e782"><p class="cl-c944d094"><span class="cl-c9419d98">2</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-c944e783"><p class="cl-c944d08a"><span class="cl-c9419d98">Tilia americana</span></p></td><td class="cl-c944e784"><p class="cl-c944d08a"><span class="cl-c9419d98">site_02</span></p></td><td class="cl-c944e78c"><p class="cl-c944d094"><span class="cl-c9419d98">1</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-c944e77a"><p class="cl-c944d08a"><span class="cl-c9419d98">Tilia americana</span></p></td><td class="cl-c944e77b"><p class="cl-c944d08a"><span class="cl-c9419d98">site_03</span></p></td><td class="cl-c944e782"><p class="cl-c944d094"><span class="cl-c9419d98">2</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-c944e783"><p class="cl-c944d08a"><span class="cl-c9419d98">Pinus strobus</span></p></td><td class="cl-c944e784"><p class="cl-c944d08a"><span class="cl-c9419d98">site_01</span></p></td><td class="cl-c944e78c"><p class="cl-c944d094"><span class="cl-c9419d98">3</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-c944e77a"><p class="cl-c944d08a"><span class="cl-c9419d98">Pinus strobus</span></p></td><td class="cl-c944e77b"><p class="cl-c944d08a"><span class="cl-c9419d98">site_02</span></p></td><td class="cl-c944e782"><p class="cl-c944d094"><span class="cl-c9419d98">2</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-c944e783"><p class="cl-c944d08a"><span class="cl-c9419d98">Pinus strobus</span></p></td><td class="cl-c944e784"><p class="cl-c944d08a"><span class="cl-c9419d98">site_03</span></p></td><td class="cl-c944e78c"><p class="cl-c944d094"><span class="cl-c9419d98">0</span></p></td></tr></tbody></table></div>
<p>::: :::</p>
<p>This is done using the <code>pivot_longer</code> function. We will specify what columns to include in the pivot with <code>cols = c(columnsToBeIncluded)</code>. All column names included in the <code>cols</code> function will now be under the new column <code>measurementType</code>, named using <code>names_to</code> and the old columns’ values under the new column <code>measurementValue</code>, named with <code>values_to</code>.</p>
<p>We use pivot to wrangle the eMoF table, and the pertinent chunk of code looks something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pivot_longer</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"COREWDTH"</span>, <span class="st">"MINCDIST"</span>, <span class="st">"MAXCDIST"</span>, <span class="st">"ADEPZZ01"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">"PRPCL064"</span>, <span class="st">"PRPCL088"</span>, <span class="st">"proportionGravel(&gt;2000um)"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>             ),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"measurementType"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"measurementValue"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_drop_na =</span> <span class="cn">TRUE</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the full code chunk where we first do a variety of mutates prior to the pivot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>SedChem <span class="ot">&lt;-</span> SedChem <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">SampleID =</span> CoreID</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>Infauna_emof <span class="ot">&lt;-</span> Infauna <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(SedChem) <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">materialEntityID =</span> SampleID,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationID =</span> Station</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate =</span> DateCollected <span class="sc">%&gt;%</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(<span class="st">"%m/%d/%Y"</span>),</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> <span class="fu">paste</span>(Site, eventDate <span class="sc">%&gt;%</span> <span class="fu">as.character</span>(), materialEntityID, <span class="at">sep =</span> <span class="st">"_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="at">pattern =</span> <span class="st">"-"</span>),</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAXCDIST =</span> <span class="fu">str_split_i</span>(Fraction, <span class="at">pattern =</span> <span class="st">"-"</span>, <span class="at">i =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> readr<span class="sc">::</span><span class="fu">parse_number</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.character</span>(),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">MINCDIST =</span> <span class="fu">str_split_i</span>(Fraction, <span class="at">pattern =</span> <span class="st">"-"</span>, <span class="at">i =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> readr<span class="sc">::</span><span class="fu">parse_number</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.character</span>(),</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PRPCL064"</span> <span class="ot">=</span> <span class="fu">as.character</span>(Sand),</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PRPCL088"</span> <span class="ot">=</span> <span class="fu">as.character</span>(Mud),</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"proportionGravel(&gt;2000um)"</span> <span class="ot">=</span> <span class="fu">as.character</span>(Gravel),</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">ADEPZZ01 =</span> <span class="fu">as.character</span>(Depth),</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">COREWDTH =</span> <span class="fu">as.character</span>(CoreDiameter)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="fu">pivot_longer</span>(</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"COREWDTH"</span>, <span class="st">"MINCDIST"</span>, <span class="st">"MAXCDIST"</span>, <span class="st">"ADEPZZ01"</span>,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>             <span class="st">"PRPCL064"</span>, <span class="st">"PRPCL088"</span>, <span class="st">"proportionGravel(&gt;2000um)"</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>             ),</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"measurementType"</span>,</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"measurementValue"</span>,</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_drop_na =</span> <span class="cn">TRUE</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="occurrences-and-worms" class="level4">
<h4 class="anchored" data-anchor-id="occurrences-and-worms">Occurrences and WoRMS</h4>
<p>Occurrence tables require some taxonomic information that may not be provided in your data. In these cases, we will need to call taxonomic information using the <code>worrms</code> package. In addition to the required <code>scientificName</code> and <code>scientificNameID</code> fields, it is valuable to provide other information if it is available, like <code>taxonRank</code>, which is the lowest identifiable taxon of an occurrence, and corresponding parent taxa.</p>
<p>We will assign <code>AphiaID</code> from the occurrence table to a new variable <code>myAphiaID</code> which we will use to call the corresponding WoRMS data. Adding <code>lapply</code> to circumvent limits on the number of inputs, we then use <code>wm_record(id = x)</code>, where <code>x</code> is <code>myAphiaID</code>. From the new table, we just pull the columns that we need using <code>select</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>myAphiaID <span class="ot">&lt;-</span> Infauna<span class="sc">$</span>AphiaID <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>myAphiaID <span class="ot">&lt;-</span> <span class="fu">lapply</span>(myAphiaID, <span class="cf">function</span>(x) <span class="fu">wm_record</span>(<span class="at">id =</span> x)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">rbindlist</span>()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>uniqueAphiaSelectColumns <span class="ot">&lt;-</span> <span class="fu">select</span>(<span class="at">.data =</span> myAphiaID,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>scientificname, rank, kingdom, phylum, class, order, family, genus, lsid, AphiaID</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientficName =</span> scientificname,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">taxonRank =</span> rank,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID =</span> lsid</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="joins" class="level4">
<h4 class="anchored" data-anchor-id="joins">Joins</h4>
<p>Joins are useful if data from multiple tables need to be included in the final table, like when we make a new table with WoRMS data. <code>left_join</code> will join table <code>x</code> to table <code>y</code> by values in the specified columns, so this function will join the tables <code>Infauna_Occurrence</code> and <code>uniqueAphiaSelectColumns</code> by matching <code>AphiaID</code> from both.</p>
<p>After combining these tables and mutating our final iteration of <code>scientificNameID</code>, we have finished our <code>occurrence</code> table!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in this case, TSN was provided because it was listed in the original dataset, however it is not required to have both AphiaID and TSN</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Occurrence_Ext <span class="ot">&lt;-</span> <span class="fu">left_join</span>(Infauna_Occurrence, uniqueAphiaSelectColumns, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"AphiaID"</span> <span class="ot">=</span> <span class="st">"AphiaID"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">TSN =</span> <span class="fu">paste</span>(<span class="st">"urn:lsid:itis.gov:itis_tsn:"</span>, TSN),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID =</span> <span class="fu">paste</span>(scientificNameID, TSN, <span class="at">sep =</span> <span class="st">", "</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="writing-data" class="level3">
<h3 class="anchored" data-anchor-id="writing-data">Writing Data</h3>
</section>
</section>
</section>
<section id="uploading-to-the-ipt" class="level1">
<h1>Uploading to the IPT</h1>
</section>
<section id="creating-eml-metadata" class="level1">
<h1>Creating EML Metadata</h1>
</section>
<section id="publishing-to-obis-and-gbif" class="level1">
<h1>Publishing to OBIS and GBIF</h1>
</section>
<section id="understanding-dataset-use-statistics" class="level1">
<h1>Understanding Dataset Use Statistics</h1>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>